{% extends "base.html" %}
{% block title %}Wyszukiwarka zgon√≥w{% endblock %}

{% block content %}
<div class="row g-4 align-items-start">
  <!-- LEWA KOLUMNA: WYSZUKIWARKA + INFORMACJA -->
  <div class="col-lg-5">
    <div class="card shadow-sm border-0">
      <div class="card-body p-4">
        <h1 class="h4 mb-1">Wyszukiwarka</h1>
        <p class="text-muted mb-4">
          Wpisz imiƒô i nazwisko (mo≈ºe byƒá fragment). Wyniki sƒÖ niewra≈ºliwe na wielko≈õƒá liter.
        </p>

        <form id="searchForm" method="post" action="/search" class="needs-validation" novalidate>
          <label class="form-label fw-semibold">Imiƒô i nazwisko</label>
          <div class="input-group input-group-lg">
            <input
              type="text"
              name="query"
              class="form-control"
              placeholder="np. J√≥zefa Bubelnik"
              value="{{ query or '' }}"
            >
            <button class="btn btn-primary" type="submit">Szukaj</button>
          </div>
          
          <div class="accordion mt-3" id="advAccordion">
            <div class="accordion-item">
              <h2 class="accordion-header" id="advHeading">
                <button class="accordion-button {% if not (year_from or year_to or age_from or age_to or sort_by) %}collapsed{% endif %}"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#advCollapse"
                        aria-expanded="{% if year_from or year_to or age_from or age_to or sort_by %}true{% else %}false{% endif %}"
                        aria-controls="advCollapse">
                  Dodatkowe opcje
                </button>
              </h2>

              <div id="advCollapse"
                    class="accordion-collapse collapse {% if year_from or year_to or age_from or age_to or sort_by %}show{% endif %}"
                    aria-labelledby="advHeading" data-bs-parent="#advAccordion">
                <div class="accordion-body">

                  <!-- ROK ZGONU -->
                  <div class="fw-semibold small mb-1">Rok zgonu</div>
                  <div class="d-flex gap-2">
                    <input type="number" name="year_from" class="form-control"
                          placeholder="od (np. 1900)" min="1500" max="2100"
                          value="{{ year_from or '' }}">
                    <input type="number" name="year_to" class="form-control"
                          placeholder="do (np. 1905)" min="1500" max="2100"
                          value="{{ year_to or '' }}">
                  </div>
                  <div class="text-muted small mt-1">Mo≈ºesz wpisaƒá tylko jedno pole (pojedynczy rok).</div>

                  <!-- WIEK -->
                  <div class="fw-semibold small mt-3 mb-1">Wiek (lata)</div>
                  <div class="d-flex gap-2">
                    <input type="number" name="age_from" class="form-control"
                          placeholder="od (np. 20)" min="0" max="130"
                          value="{{ age_from or '' }}">
                    <input type="number" name="age_to" class="form-control"
                          placeholder="do (np. 40)" min="0" max="130"
                          value="{{ age_to or '' }}">
                  </div>
                  <div class="text-muted small mt-1">0 oznacza &lt; 1 rok.</div>

                  <!-- SORTOWANIE -->
                  <div class="fw-semibold small mt-3 mb-1">Sortuj wed≈Çug</div>
                  <div class="d-flex gap-2">
                    <select name="sort_by" class="form-select form-select-dark">
                      <option value="" {% if not sort_by %}selected{% endif %}>Domy≈õlnie (ID)</option>
                      <option value="name" {% if sort_by=='name' %}selected{% endif %}>Nazwisko / imiƒô</option>
                      <option value="year" {% if sort_by=='year' %}selected{% endif %}>Rok zgonu</option>
                      <option value="age"  {% if sort_by=='age' %}selected{% endif %}>Wiek (lata)</option>
                    </select>

                    <select name="sort_dir" class="form-select form-select-dark" style="max-width: 180px;">
                      <option value="asc"  {% if sort_dir=='asc' %}selected{% endif %}>RosnƒÖco</option>
                      <option value="desc" {% if sort_dir=='desc' %}selected{% endif %}>MalejƒÖco</option>
                    </select>
                  </div>

                </div>
              </div>
            </div>
          </div>

            <!-- NOWE POLE: PARAFIA -->
  <label class="form-label fw-semibold mt-3">Parafia</label>
  <select id="parafiaSelect" name="parafia" class="form-select form-select-dark">
    <option value="">Wybierz wszystkie parafie</option>
    {% for p in parishes %}
      <option value="{{ p }}" {% if selected_parafia == p %}selected{% endif %}>
        {{ p }}
      </option>
    {% endfor %}
  </select>

          <div class="invalid-feedback">
            Podaj przynajmniej jedno imiƒô lub nazwisko.
          </div>
        </form>

        <div class="mt-4">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <span class="fw-semibold">Wyniki</span>
            {% if results is not none %}
              <span class="badge text-bg-dark rounded-pill">{{ results|length }}</span>
            {% endif %}
          </div>

          {% if results is not none %}
            {% if results|length == 0 %}
              <div class="alert alert-warning mt-2 mb-0">
                Brak wynik√≥w dla: <strong>{{ query }}</strong>
              </div>
            {% else %}
              <div class="alert alert-success mt-2 mb-0">
                Znaleziono rekord√≥w: <strong>{{ results|length }}</strong>
              </div>
            {% endif %}
          {% endif %}
        </div>
      </div>
    </div>

    <div class="card border-0 mt-4 info-card">
      <div class="card-body p-4">
        <div class="fw-semibold mb-2">Informacja</div>
        <div class="text-muted small">
          Dane pochodzƒÖ z akt parafialnych, protoko≈Ç√≥w zgon√≥w oraz rejestr√≥w ludno≈õci.
          Wpisy mogƒÖ posiadaƒá braki, nadpisy lub skr√≥ty w≈Ça≈õciwe dla epoki.
        </div>
      </div>
    </div>
  </div>

  <!-- PRAWA KOLUMNA: REKORDY -->
  <div class="col-lg-7">
    <div class="card shadow-sm border-0 records-panel">
      <div class="card-body p-0">
        <div class="records-header p-4 border-bottom">
          <div class="d-flex align-items-center justify-content-between">
            <h2 class="h5 mb-0">REKORDY</h2>
            <div class="text-muted small">
              {% if results is none %}
                Wybierz parafiƒô lub wpisz frazƒô.
              {% else %}
                Wy≈õwietlam: {{ results|length }}
              {% endif %}
            </div>
          </div>
        </div>

        {% if results %}
          <div class="records-list p-3">
            {% for r in results %}
            <article class="record-card mb-3">
                <header class="record-card-header">
                  <div class="record-id">#{{ r.id }}</div>
                  <div class="record-name">{{ r.imie_nazwisko_hl | safe }}</div>

                  {% if r.image_url %}
                    <div class="record-source small">
                      <a href="{{ r.image_url }}" target="_blank" class="text-muted">
                        Zobacz skan
                      </a>
                    </div>
                  {% endif %}
                </header>


             <div class="record-card-body">
  <div class="record-field">
    <div class="record-label">WIEK</div>
    <div class="record-value">
      {{ r.wiek or "brak danych" }}
    </div>
  </div>

  <div class="record-field">
    <div class="record-label">MIEJSCE URODZENIA</div>
    <div class="record-value">
      {{ r.miejsce_urodzenia or "brak informacji" }}
    </div>
  </div>

  <div class="record-field">
    <div class="record-label">PARAFIA</div>
    <div class="record-value">
      {{ r.parafia or "brak informacji" }}
    </div>
  </div>

  <div class="record-field">
    <div class="record-label">DATA ZGONU</div>
    <div class="record-value">
      {{ r.data_zgonu or "brak danych" }}
    </div>
  </div>

  <div class="record-field">
    <div class="record-label">PRZYCZYNA ZGONU</div>
    <div class="record-value">
      {{ r.przyczyna_zgonu or "brak danych" }}
    </div>
  </div>

  <div class="record-field record-field-wide">
    <div class="record-label">INNE WA≈ªNE INFORMACJE</div>
    <div class="record-value">
      {{ r.inne_wazne_informacje or "‚Äî" }}
    </div>
  </div>
</div>

            </article>
            {% endfor %}
          </div>
        {% else %}
          <div class="p-4">
            <div class="empty-state">
              <div class="display-6 mb-2">üîé</div>
              <div class="fw-semibold">Brak danych do wy≈õwietlenia</div>
              <div class="text-muted">Wpisz imiƒô i nazwisko i kliknij ‚ÄûSzukaj‚Äù.</div>
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
  const form = document.getElementById('searchForm');
  const parishSelect = document.getElementById('parafiaSelect');

  parishSelect?.addEventListener('change', () => {
    const selected = parishSelect.value;

    // Je≈õli wracam na "Wybierz wszystkie parafie" -> chcemy pusty stan,
    // wiƒôc czy≈õcimy query i wysy≈Çamy formularz (backend zwr√≥ci results=None)
    if (!selected) {
      form.query.value = '';
      if (form.year_from) form.year_from.value = '';
      if (form.year_to) form.year_to.value = '';
      if (form.age_from) form.age_from.value = '';
      if (form.age_to) form.age_to.value = '';
      if (form.sort_by) form.sort_by.value = '';
      if (form.sort_dir) form.sort_dir.value = 'asc';
    }
    form.submit();
  });
</script>

<script>
(() => {
  'use strict';
  const forms = document.querySelectorAll('.needs-validation');
  Array.from(forms).forEach(form => {
    form.addEventListener('submit', event => {
      if (!form.checkValidity()) {
        event.preventDefault();
        event.stopPropagation();
      }
      form.classList.add('was-validated');
    }, false);
  });
})();
</script>
{% endblock %}
